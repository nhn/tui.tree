<!DOCTYPE html>
<html>
    <head lang="en">
        <meta charset="UTF-8">
        <title>Tree with "Ajax" feature</title>
        <link rel="stylesheet" type="text/css" href="./css/tui-example-style.css" />
        <link rel="stylesheet" type="text/css" href="./css/docs.css" />
        <link rel="stylesheet" type="text/css" href="../dist/tui-tree.css" />
        <link rel="stylesheet" type="text/css" href="https://uicdn.toast.com/tui.context-menu/v2.1.6/tui-context-menu.css" />
    </head>

    <body>
        <div class="code-html">
            <div id="tree" class="tui-tree-wrap"></div>
        </div>
        <div class="explain">
            <h3>To create / update / remove a tree node, please right-click.</h3>
            <p>ContextMenu feature does not support IE8.</p>
            <textarea id="infoArea" readonly></textarea>
        </div>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
        <script src="https://uicdn.toast.com/tui.context-menu/v2.1.6/tui-context-menu.min.js"></script>
        <script src="../dist/tui-tree.js"></script>
        <script class="code-js">
        var infoArea = document.getElementById('infoArea');

        // Create Tree component
        var tree = new tui.Tree('tree', {
            nodeDefaultState: 'opened',
            template: {
                internalNode: // Change to Mustache's format
                    '<div class="tui-tree-content-wrapper" style="padding-left: {{indent}}px">' + // Example for using indent value
                        '<button type="button" class="tui-tree-toggle-btn tui-js-tree-toggle-btn">' +
                            '<span class="tui-ico-tree"></span>' +
                            '{{stateLabel}}' +
                        '</button>' +
                        '<span class="tui-tree-text tui-js-tree-text">' +
                            '<span class="tui-tree-ico tui-ico-folder"></span>' +
                            '{{text}}' +
                        '</span>' +
                    '</div>' +
                    '<ul class="tui-tree-subtree tui-js-tree-subtree">' +
                        '{{children}}' + // Mustache's format
                    '</ul>',
                leafNode:
                    '<div class="tui-tree-content-wrapper" style="padding-left: {{indent}}px">' + // Example for using indent value
                        '<span class="tui-tree-text {{textClass}}">' +
                            '<span class="tui-tree-ico tui-ico-file"></span>' +
                            '{{text}}' +
                        '</span>' +
                    '</div>'
            }
        });

        // Add features
        tree.enableFeature('Selectable')
            .enableFeature('Editable', {
            dataKey: 'text'
        }).enableFeature('Draggable', {
            isSortable: true
        }).enableFeature('ContextMenu', {
            menuData: [
                {title: 'create', command: 'create'},
                {title: 'update', command: 'update'},
                {title: 'remove', command: 'remove'}
            ]
        }).enableFeature('Ajax', {
            command: {
                read: {
                    url: 'data/tree.js',
                    dataType: 'jsonp',
                    jsonpCallback: 'dataCallback',
                    data: function(params) {
                        return {
                            productId: tree.getNodeData(params.nodeId).pid
                        };
                    }
                },
                create: {
                    url: 'data/response.js',
                    dataType: 'jsonp',
                    jsonpCallback: 'dataCallback',
                    data: function(params) {
                        return {
                            targetId: tree.getNodeData(params.parentId).pid,
                            productName: params.data.text
                        };
                    }
                },
                update: {
                    url: 'data/response.js',
                    dataType: 'jsonp',
                    jsonpCallback: 'dataCallback',
                    data: function(params) {
                        return {
                            productId: tree.getNodeData(params.nodeId).pid,
                            productName: params.data.text
                        };
                    }
                },
                remove: {
                    url: 'data/response.js',
                    dataType: 'jsonp',
                    jsonpCallback: 'dataCallback',
                    data: function(params) {
                        return {
                            productId: tree.getNodeData(params.nodeId).pid
                        };
                    }
                },
                move: {
                    url: 'data/response.js',
                    dataType: 'jsonp',
                    jsonpCallback: 'dataCallback',
                    data: function(params) {
                        return {
                            productId: tree.getNodeData(params.nodeId).pid,
                            targetId: tree.getNodeData(params.newParentId).pid,
                            moveIdx: params.index
                        };
                    }
                }
            },
            parseData: function(command, response) {
                if (command === 'read') {
                    return response.code === '200' ? response.tree : false;
                } else {
                    return response.code === '200';
                }
            }
        });

        // Bind custom event
        tree.on('selectContextMenu', function(e) {
            var cmd = e.cmd;
            var nodeId = e.nodeId;

            switch (cmd) {
                case 'create':
                    tree.createChildNode(nodeId);
                    break;
                case 'update':
                    tree.editNode(nodeId);
                    break;
                case 'remove':
                    tree.remove(nodeId);
                    break;
            }
        });

        tree.on('beforeCreateChildNode', function(event) {
            if (event.cause === 'blur') {
                tree.finishEditing();
                tree.remove(event.nodeId);
                return false;
            }
            return confirm('Are you sure you want to create?');
        });

        tree.on('beforeEditNode', function(event) {
            if (event.cause === 'blur') {
                tree.finishEditing();
                return false;
            }
            return confirm('Are you sure you want to edit?');
        });

        tree.on('beforeMove', function() {
            console.log('before move');
        });

        tree.on('successAjaxResponse', function(eventData) {
            var message = '';
            
            message += 'jQuery request : \n';
            message += JSON.stringify(tree.enabledFeatures.Ajax.command[eventData.command], null, 8) + '\n\n';

            message += 'jQuery response : \n';
            message += JSON.stringify(eventData, null, 8);

            infoArea.value = message;
        });
        </script>
    </body>
</html>
